<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Click Pass Scanner</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      background: linear-gradient(to right, #f7f8fc, #e3e6f0);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 30px;
    }

    .container {
      background: white;
      padding: 25px 30px;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      max-width: 420px;
      width: 100%;
      text-align: center;
    }

    .logo {
      width: 140px;
      margin-bottom: 10px;
    }

    h2 {
      margin-top: 0;
      margin-bottom: 15px;
      color: #333;
    }

    .lang-switch {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
    }

    .lang-switch button {
      flex: 1;
      padding: 12px;
      font-size: 16px;
      font-weight: bold;
      border: none;
      background: #f0f0f0;
      color: #333;
      margin: 0 5px;
      border-radius: 10px;
      cursor: pointer;
      transition: 0.3s;
    }

    .lang-switch button.active {
      background: #007bff;
      color: white;
    }

    input {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 15px;
    }

    #reader {
      width: 100%;
      max-width: 300px;
      margin: 0 auto;
      border: 1px solid #ccc;
      border-radius: 10px;
    }

    button.action-btn {
      background: #00b2ff;
      color: white;
      padding: 12px 20px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
      transition: background 0.3s;
    }

    button.action-btn:hover {
      background: #0090d4;
    }

    button.pay-btn {
      background: #28a745;
      color: white;
      padding: 12px 20px;
      font-size: 16px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 10px;
      width: 100%;
      transition: background 0.3s;
    }

    button.pay-btn:hover {
      background: #218838;
    }

    #status {
      margin-top: 15px;
      font-size: 14px;
      color: #444;
      min-height: 20px;
    }

    #animation-box {
      margin-top: 20px;
      height: 100px;
    }
    .preferred-amounts button {
      background: #f0f0f0;
      border: 1px solid #ccc;
      margin: 4px;
      padding: 8px 14px;
      border-radius: 8px;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .preferred-amounts button:hover {
      background: #d9eaff;
    }

  </style>
</head>
<body>
  <div class="container">
    <img src="static/clicklogo.png" alt="Click Logo" class="logo">
    <h2 id="title">Scan Payme GO QR</h2>

    <div class="lang-switch">
      <button id="btn-uz" onclick="setLanguage('uz')">üá∫üáø O'zbek</button>
      <button id="btn-ru" onclick="setLanguage('ru')">üá∑üá∫ –†—É—Å—Å–∫–∏–π</button>
    </div>

    <form id="payment-form">
      <input type="number" step="0.01" id="amount" placeholder="Amount (UZS)" required>


      <!-- Preferred amounts section -->
      <div class="preferred-amounts" style="margin: 10px 0;">

        <div>
          <button type="button" onclick="setPreferredAmount(23000)">23000</button>
          <button type="button" onclick="setPreferredAmount(28000)">28000</button>
          <button type="button" onclick="setPreferredAmount(33000)">33000</button>
          <button type="button" onclick="setPreferredAmount(38000)">38000</button>
        </div>
      </div>
      <input type="text" id="desc" placeholder="Description">
      <input type="text" id="gun-scanner-input" placeholder="Gun Scanner Input">
      <div id="reader"></div>
      <button type="button" class="action-btn" onclick="startCamera()" id="start-btn">Start Camera</button>

      <p id="status">Click "Start Camera" to begin scanning.</p>
      <div id="animation-box"></div>
    </form>
  </div>

  <script>
    let scanner = null;
    let isCameraRunning = false;
    let currentLang = 'uz';

    const translations = {
      uz: {
        title: "Click Pass QR kodini skanerlash",
        amount: "Summani kiriting (UZS)",
        desc: "Izoh",
        gunScanner: "Skaneri resultati",
        start: "Kamerani yoqish",
        pay: "To‚Äòlash",
        clickToStart: "üì∑ QR kodni skanerlash uchun 'Kamerani yoqish' tugmasini bosing.",
        alreadyRunning: "‚ö†Ô∏è Kamera allaqan ishlayapti.",
        noCamera: "‚ùå Kamera topilmadi.",
        processing: "‚è≥ To'lov amalga oshirilmoqda...",
        success: "‚úÖ To'lov muvaffaqiyatli yakunlandi!",
        failed: "‚ùå To'lov amalga oshmadi",
        enterAmount: "‚ùå Iltimos, summani kiriting.",
        networkError: "‚ùå Tarmoq xatosi"
      },
      ru: {
        title: "–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR Click Pass",
        amount: "–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É (UZS)",
        desc: "–û–ø–∏—Å–∞–Ω–∏–µ",
        gunScanner: "–°–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö–∫–æ–¥–∞",
        start: "–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É",
        pay: "–û–ø–ª–∞—Ç–∏—Ç—å",
        clickToStart: "üì∑ –ù–∞–∂–º–∏—Ç–µ '–ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É' –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR-–∫–æ–¥–∞.",
        alreadyRunning: "‚ö†Ô∏è –ö–∞–º–µ—Ä–∞ —É–∂–µ –∞–∫—Ç–∏–≤–Ω–∞.",
        noCamera: "‚ùå –ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.",
        processing: "‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞—Ç–µ–∂–∞...",
        success: "‚úÖ –ü–ª–∞—Ç–µ–∂ –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ!",
        failed: "‚ùå –ü–ª–∞—Ç–µ–∂ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω",
        enterAmount: "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É.",
        networkError: "‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏"
      }
    };

    function setLanguage(lang) {
      currentLang = lang;
      const t = translations[lang];
      document.getElementById('title').innerText = t.title;
      document.getElementById('amount').placeholder = t.amount;
      document.getElementById('desc').placeholder = t.desc;
      document.getElementById('gun-scanner-input').placeholder = t.gunScanner;
      document.getElementById('start-btn').innerText = t.start;
      
      document.getElementById('status').innerText = t.clickToStart;
      document.getElementById('btn-uz').classList.toggle('active', lang === 'uz');
      document.getElementById('btn-ru').classList.toggle('active', lang === 'ru');
    }

    function startCamera() {
      const t = translations[currentLang];
      const status = document.getElementById('status');
      if (isCameraRunning) {
        status.innerText = t.alreadyRunning;
        return;
      }

      scanner = new Html5Qrcode("reader");

      Html5Qrcode.getCameras().then(devices => {
        if (!devices || devices.length === 0) {
          status.innerText = t.noCamera;
          return;
        }

        const cameraId = devices[0].id;

        scanner.start(
          cameraId,
          { fps: 10, qrbox: 250 },
          (decodedText) => handleScanResult(decodedText),
          (err) => console.warn("Scan error:", err)
        ).then(() => {
          isCameraRunning = true;
          status.innerText = t.clickToStart;
        }).catch(err => {
          status.innerText = "‚ùå Camera error: " + err;
        });
      }).catch(err => {
        status.innerText = "‚ùå " + err;
      });
    }

    function handleScanResult(qrCodeMessage) {
      if (scanner) {
        scanner.stop().then(() => {
          isCameraRunning = false;
        }).catch(() => {});
      }

      const t = translations[currentLang];
      const amount = document.getElementById("amount").value.trim();
      const desc = document.getElementById("desc").value.trim();

      if (!amount) {
        document.getElementById("status").innerText = t.enterAmount;
        return;
      }

      document.getElementById("status").innerText = t.processing;

      fetch("/pay", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ token: qrCodeMessage, amount, description: desc })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "success") {
          document.getElementById("status").innerText = t.success;
        } else {
          document.getElementById("status").innerText = `${t.failed}: ${JSON.stringify(data.response)}`;
        }
      })
      .catch(err => {
        document.getElementById("status").innerText = `${t.networkError}: ${err.message}`;
      });
    }

    function handlePayment() {
      const t = translations[currentLang];
      const amount = document.getElementById("amount").value.trim();
      const desc = document.getElementById("desc").value.trim();
      const token = document.getElementById("gun-scanner-input").value.trim();

      if (!amount) {
        document.getElementById("status").innerText = t.enterAmount;
        return;
      }

      if (!token) {
        document.getElementById("status").innerText = "‚ùå QR token not found.";
        return;
      }

      document.getElementById("status").innerText = t.processing;

      fetch("/pay", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          token: token,
          amount: amount,
          description: desc
        })
      })
      .then(res => res.json())
      .then(data => {
        if (data.status === "success") {
          document.getElementById("status").innerText = t.success;
        } else {
          document.getElementById("status").innerText = `${t.failed}: ${JSON.stringify(data.response)}`;
        }
      })
      .catch(err => {
        document.getElementById("status").innerText = `${t.networkError}: ${err.message}`;
      });
    }

    document.getElementById('gun-scanner-input').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        handlePayment();
        this.value = '';
      }
    });
    function setPreferredAmount(value) {
      document.getElementById('amount').value = value;
    }

    setLanguage('uz');
  </script>
</body>
</html>